<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ© - Ø§Ù„Ù…Ø±ÙŠØ¶</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --warning: #e74c3c;
            --dark: #2c3e50;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--primary);
        }
        
        h1 {
            color: var(--dark);
            margin-bottom: 10px;
        }
        
        .header-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .info-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
        
        .medication-section, .calendar-section, .sidebar {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .time-slot {
            margin-bottom: 25px;
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            border-right: 5px solid var(--primary);
        }
        
        .medication-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 10px;
            border: 1px solid #eee;
            transition: all 0.3s;
        }
        
        .medication-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .checkbox-container input {
            display: none;
        }
        
        .checkmark {
            width: 40px;
            height: 40px;
            background: #f1f1f1;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid #ddd;
        }
        
        .checkbox-container input:checked ~ .checkmark {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }
        
        .status-taken {
            background: rgba(46, 204, 113, 0.1) !important;
            border-color: rgba(46, 204, 113, 0.3) !important;
        }
        
        .critical-med {
            background: rgba(231, 76, 60, 0.05) !important;
            border-right: 3px solid var(--warning) !important;
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 5px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-success { background: var(--secondary); }
        .btn-success:hover { background: #27ae60; }
        
        .btn-warning { background: var(--warning); }
        .btn-warning:hover { background: #c0392b; }
        
        .firebase-status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .status-connected {
            background: #2ecc71;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
            100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }
        
        .fcm-token-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px dashed #ddd;
        }
        
        .fcm-token {
            font-family: monospace;
            word-break: break-all;
            font-size: 0.9rem;
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--secondary);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 10000;
            display: none;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Ø­Ø§Ù„Ø© Firebase -->
    <div class="firebase-status" id="firebase-status">
        <div class="status-dot" id="firebase-status-dot"></div>
        <span id="firebase-status-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...</span>
    </div>
    
    <!-- Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ø§Ø¦Ù…Ø© -->
    <div class="notification" id="floating-notification"></div>
    
    <div class="container">
        <header>
            <h1><i class="fas fa-pills"></i> Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ© - Ø§Ù„Ù…Ø±ÙŠØ¶</h1>
            <p>Ø³Ø¬Ù„ Ø£Ø¯ÙˆÙŠØªÙƒ ÙˆØ£Ø±Ø³Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ©</p>
            
            <div class="header-info">
                <div class="info-card">
                    <div class="info-title">Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</div>
                    <div class="info-value" id="patient-name">ÙˆØ§Ù„Ø¯/ÙˆØ§Ù„Ø¯Ø©</div>
                </div>
                <div class="info-card">
                    <div class="info-title">Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…Ø£Ø®ÙˆØ°Ø©</div>
                    <div class="info-value" id="taken-count">0/20</div>
                </div>
                <div class="info-card">
                    <div class="info-title">Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div>
                    <div class="info-value" id="notification-status" style="color: orange;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©</div>
                </div>
                <div class="info-card">
                    <div class="info-title">FCM Token</div>
                    <div class="info-value" id="fcm-token-short">ØºÙŠØ± Ù…ØªÙˆÙØ±</div>
                </div>
            </div>
        </header>
        
        <div class="dashboard">
            <!-- Ù‚Ø³Ù… Ø§Ù„Ø£Ø¯ÙˆÙŠØ© -->
            <div class="medication-section">
                <h2><i class="fas fa-calendar-check"></i> Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠ</h2>
                
                <!-- Ù…Ø«Ø§Ù„ Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£Ø¯ÙˆÙŠØ© -->
                <div class="time-slot">
                    <h3><i class="fas fa-sun"></i> Ø§Ù„ØµØ¨Ø§Ø­ Ø¹Ù„Ù‰ Ø§Ù„Ø±ÙŠÙ‚ (7:00 ØµØ¨Ø§Ø­Ø§Ù‹)</h3>
                    
                    <div class="medication-item" data-med="Examide">
                        <div class="medication-info">
                            <div class="med-name">Examide 20 mg</div>
                            <div class="med-dosage">Ù‚Ø±Øµ ÙˆØ§Ø­Ø¯</div>
                        </div>
                        <div class="checkbox-container">
                            <input type="checkbox" class="med-checkbox" id="med-examide" data-med="Examide" data-time="morning">
                            <span class="checkmark"></span>
                        </div>
                    </div>
                    
                    <div class="medication-item" data-med="Norvasc">
                        <div class="medication-info">
                            <div class="med-name">Norvasc 10 mg</div>
                            <div class="med-dosage">Ù‚Ø±Øµ ÙˆØ§Ø­Ø¯</div>
                        </div>
                        <div class="checkbox-container">
                            <input type="checkbox" class="med-checkbox" id="med-norvasc" data-med="Norvasc" data-time="morning">
                            <span class="checkmark"></span>
                        </div>
                    </div>
                    
                    <button class="btn btn-warning send-group-btn" data-time="morning">
                        <i class="fas fa-bell"></i> Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨
                    </button>
                </div>
                
                <!-- Ø£Ø¯ÙˆÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ÙØ·Ø§Ø± -->
                <div class="time-slot">
                    <h3><i class="fas fa-coffee"></i> Ø¨Ø¹Ø¯ Ø§Ù„ÙØ·Ø§Ø± (9:00 ØµØ¨Ø§Ø­Ø§Ù‹)</h3>
                    
                    <div class="medication-item critical-med" data-med="Eliquis">
                        <div class="medication-info">
                            <div class="med-name">Eliquis 2.5 mg âš ï¸</div>
                            <div class="med-dosage">Ù‚Ø±Øµ ÙˆØ§Ø­Ø¯ - Ø®Ø· Ø£Ø­Ù…Ø±</div>
                        </div>
                        <div class="checkbox-container">
                            <input type="checkbox" class="med-checkbox" id="med-eliquis" data-med="Eliquis" data-time="after-breakfast">
                            <span class="checkmark"></span>
                        </div>
                    </div>
                    
                    <button class="btn btn-warning send-group-btn" data-time="after-breakfast">
                        <i class="fas fa-bell"></i> Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨
                    </button>
                </div>
                
                <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee;">
                    <h3><i class="fas fa-chart-line"></i> ØªÙ‚Ø¯Ù… Ø§Ù„ÙŠÙˆÙ…</h3>
                    <div style="background: #f1f1f1; height: 20px; border-radius: 10px; margin: 15px 0;">
                        <div id="progress-bar" style="height: 100%; background: var(--secondary); width: 0%; border-radius: 10px;"></div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-success" id="mark-all-taken">
                            <i class="fas fa-check-double"></i> ØªØ¹Ù„ÙŠÙ… Ø§Ù„ÙƒÙ„ ÙƒÙ…Ø£Ø®ÙˆØ°
                        </button>
                        <button class="btn" id="reset-day">
                            <i class="fas fa-redo"></i> Ø¨Ø¯Ø¡ ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯
                        </button>
                        <button class="btn btn-warning" id="send-test-notification">
                            <i class="fas fa-bell"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
            <div class="sidebar">
                <h2><i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
                
                <!-- FCM Token Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø±ÙŠØ¶ -->
                <div class="fcm-token-box">
                    <h4><i class="fas fa-key"></i> Ø±Ù…Ø² Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</h4>
                    <div class="fcm-token" id="fcm-token-display">
                        Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ù…Ø²...
                    </div>
                    <button class="btn" id="copy-token-btn">
                        <i class="fas fa-copy"></i> Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²
                    </button>
                    <p style="color: #666; font-size: 0.9rem; margin-top: 10px;">
                        Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² Ù…Ø¹ Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ù„ØªÙ„Ù‚ÙŠ Ø¥Ø´Ø¹Ø§Ø±Ø§ØªÙƒ
                    </p>
                </div>
                
                <!-- Ø±Ù…Ø² Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ© -->
                <div style="margin-top: 20px;">
                    <h4><i class="fas fa-user-nurse"></i> Ø±Ù…Ø² Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ©</h4>
                    <input type="text" id="caregiver-token-input" 
                           placeholder="Ø§Ù„ØµÙ‚ Ø±Ù…Ø² FCM Ù„Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ù‡Ù†Ø§"
                           style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; margin: 10px 0;">
                    <button class="btn btn-success" id="save-caregiver-token">
                        <i class="fas fa-save"></i> Ø­ÙØ¸ Ø±Ù…Ø² Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨
                    </button>
                </div>
                
                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ -->
                <div style="margin-top: 20px;">
                    <h4><i class="fas fa-user"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠ</h4>
                    <div style="margin: 10px 0;">
                        <label>Ø§Ø³Ù…ÙŠ:</label>
                        <input type="text" id="patient-name-input" value="ÙˆØ§Ù„Ø¯/ÙˆØ§Ù„Ø¯Ø©" 
                               style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; margin-top: 5px;">
                    </div>
                    <div style="margin: 10px 0;">
                        <label>Ø¹Ù…Ø±ÙŠ:</label>
                        <input type="number" id="patient-age-input" value="65" 
                               style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; margin-top: 5px;">
                    </div>
                </div>
                
                <!-- Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
                <div style="margin-top: 20px;">
                    <h4><i class="fas fa-history"></i> Ø¢Ø®Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h4>
                    <div id="notification-history" style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
                        <!-- Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù‡Ù†Ø§ -->
                    </div>
                </div>
            </div>
        </div>
        
        <footer style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; color: #666;">
            <p>Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ© &copy; 2024 | Ù…ØªØµÙ„ Ø¨Ù€ Firebase</p>
            <p id="last-update-time" style="font-size: 0.9rem; margin-top: 5px;"></p>
        </footer>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
    
    <script>
        // ØªÙƒÙˆÙŠÙ† Firebase - Ø§Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ
        const firebaseConfig = {
            apiKey: "AIzaSyAMJjeucsuWiIrOKJ19AK6VT9zLS7ZB6MY",
            authDomain: "medtrackmamdouh.firebaseapp.com",
            projectId: "medtrackmamdouh",
            storageBucket: "medtrackmamdouh.firebasestorage.app",
            messagingSenderId: "588115249832",
            appId: "1:588115249832:web:1e8a2f5dd57db68047909d"
        };
        
        // ØªÙ‡ÙŠØ¦Ø© Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let messaging = null;
        
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        const appData = {
            patientId: 'patient_' + Math.random().toString(36).substr(2, 9),
            patientName: 'ÙˆØ§Ù„Ø¯/ÙˆØ§Ù„Ø¯Ø©',
            patientAge: 65,
            fcmToken: '',
            caregiverToken: '',
            medications: {},
            lastUpdate: null
        };
        
        // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ©
        const medications = [
            { id: 'med-examide', name: 'Examide', time: 'morning', critical: false },
            { id: 'med-norvasc', name: 'Norvasc', time: 'morning', critical: false },
            { id: 'med-eliquis', name: 'Eliquis', time: 'after-breakfast', critical: true },
            { id: 'med-contorloc', name: 'Contorloc', time: 'morning', critical: false },
            { id: 'med-corvid', name: 'Corvid', time: 'morning', critical: false },
            { id: 'med-forxiga', name: 'Forxiga', time: 'before-lunch', critical: false },
            { id: 'med-plavix', name: 'Plavix', time: 'after-dinner', critical: true },
            { id: 'med-moxiflox', name: 'Moxiflox', time: 'after-dinner', critical: true },
            { id: 'med-aldomet1', name: 'Aldomet', time: 'after-breakfast', critical: false },
            { id: 'med-aldomet2', name: 'Aldomet', time: 'afternoon', critical: false },
            { id: 'med-aldomet3', name: 'Aldomet', time: 'before-bed', critical: false },
            { id: 'med-eliquis-night', name: 'Eliquis', time: 'before-bed', critical: true }
        ];
        
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await initializeFirebase();
                loadSavedData();
                setupEventListeners();
                updateProgress();
                updateLastUpdateTime();
                
                showNotification('Ù…Ø±Ø­Ø¨Ø§Ù‹', 'Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…', 'success');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©:', error);
            }
        });
        
        // ØªÙ‡ÙŠØ¦Ø© Firebase
        async function initializeFirebase() {
            try {
                updateFirebaseStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase...', 'connecting');
                
                if (!firebase.messaging.isSupported()) {
                    throw new Error('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
                }
                
                messaging = firebase.messaging();
                
                // Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    console.warn('ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
                    showNotification('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 'warning');
                }
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ FCM Token
                const token = await messaging.getToken({
                    vapidKey: 'BAHsKe2WSUDaXMcroeNScTprRmE2NTIBDyv9fYmVsuUddhERvybIKM7EBNgSHnuZ91Q9QU9V034IXnVDbeEG9oQ'
                });
                
                if (token) {
                    appData.fcmToken = token;
                    displayFCMToken(token);
                    await savePatientData(token);
                    updateFirebaseStatus('Ù…ØªØµÙ„', 'connected');
                    showNotification('ØªÙ… Ø§Ù„ØªÙ‡ÙŠØ¦Ø©', 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }
                
                // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                setupFirebaseListeners();
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase:', error);
                updateFirebaseStatus('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
            }
        }
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹Ø§Øª Firebase
        function setupFirebaseListeners() {
            if (!messaging) return;
            
            // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø£Ø«Ù†Ø§Ø¡ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            messaging.onMessage((payload) => {
                console.log('ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¥Ø´Ø¹Ø§Ø±:', payload);
                if (payload.notification) {
                    showNotification(payload.notification.title, payload.notification.body, 'info');
                    addToNotificationHistory(payload.notification.title, payload.notification.body);
                }
            });
            
            // ØªØ­Ø¯ÙŠØ« Token Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
            messaging.onTokenRefresh(() => {
                messaging.getToken().then((newToken) => {
                    if (newToken) {
                        appData.fcmToken = newToken;
                        displayFCMToken(newToken);
                        savePatientData(newToken);
                        showNotification('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ù…Ø² Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 'success');
                    }
                });
            });
        }
        
        // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ ÙÙŠ Firebase
        async function savePatientData(token) {
            try {
                await db.collection('patients').doc(appData.patientId).set({
                    patientName: appData.patientName,
                    patientAge: appData.patientAge,
                    fcmToken: token,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    medicationsTaken: Object.keys(appData.medications).length
                }, { merge: true });
                
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶');
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            }
        }
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø£Ø®Ø° Ø§Ù„Ø¯ÙˆØ§Ø¡
        async function sendMedicationNotification(medicationName) {
            if (!appData.caregiverToken) {
                showNotification('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø±Ù…Ø² Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ©', 'warning');
                return;
            }
            
            try {
                const currentTime = new Date().toLocaleTimeString('ar-EG');
                
                // Ø­ÙØ¸ ÙÙŠ Firestore
                await db.collection('medication_events').add({
                    patientId: appData.patientId,
                    patientName: appData.patientName,
                    medication: medicationName,
                    time: currentTime,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'medication_taken',
                    fcmToken: appData.fcmToken
                });
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù…Ø¨Ø§Ø´Ø± Ø¥Ù„Ù‰ Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ©
                const response = await fetch('https://us-central1-medtrackmamdouh.cloudfunctions.net/sendNotification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: appData.caregiverToken,
                        notification: {
                            title: 'ğŸ’Š ØªÙ… Ø£Ø®Ø° Ø§Ù„Ø¯ÙˆØ§Ø¡',
                            body: `${appData.patientName} Ø£Ø®Ø° ${medicationName} Ø§Ù„Ø³Ø§Ø¹Ø© ${currentTime}`
                        },
                        data: {
                            patientId: appData.patientId,
                            patientName: appData.patientName,
                            medication: medicationName,
                            time: currentTime,
                            type: 'medication_taken'
                        }
                    })
                });
                
                if (response.ok) {
                    showNotification('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ©', 'success');
                    addToNotificationHistory('ØªÙ… Ø£Ø®Ø° Ø§Ù„Ø¯ÙˆØ§Ø¡', `Ø£Ø®Ø°Øª ${medicationName}`);
                }
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:', error);
                showNotification('Ø®Ø·Ø£', 'ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±', 'error');
            }
        }
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¬Ù…Ø§Ø¹ÙŠ
        async function sendGroupNotification(timeSlot) {
            if (!appData.caregiverToken) {
                showNotification('ØªÙ†Ø¨ÙŠÙ‡', 'Ø£Ø¶Ù Ø±Ù…Ø² Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            const groupName = {
                'morning': 'Ø£Ø¯ÙˆÙŠØ© Ø§Ù„ØµØ¨Ø§Ø­ Ø¹Ù„Ù‰ Ø§Ù„Ø±ÙŠÙ‚',
                'after-breakfast': 'Ø£Ø¯ÙˆÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ÙØ·Ø§Ø±'
            }[timeSlot] || `Ø£Ø¯ÙˆÙŠØ© ${timeSlot}`;
            
            try {
                const response = await fetch('https://us-central1-medtrackmamdouh.cloudfunctions.net/sendNotification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: appData.caregiverToken,
                        notification: {
                            title: `ğŸ“‹ ${groupName}`,
                            body: `${appData.patientName}: Ø­Ø§Ù† ÙˆÙ‚Øª ${groupName}`
                        },
                        data: {
                            patientId: appData.patientId,
                            patientName: appData.patientName,
                            group: groupName,
                            time: new Date().toLocaleTimeString('ar-EG'),
                            type: 'group_notification'
                        }
                    })
                });
                
                if (response.ok) {
                    showNotification('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù† ${groupName}`, 'success');
                }
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ:', error);
            }
        }
        
        // ØªÙ‡ÙŠØ¦Ø© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        function setupEventListeners() {
            // Ù…Ø³ØªÙ…Ø¹Ø§Øª ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©
            medications.forEach(med => {
                const checkbox = document.getElementById(med.id);
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        const isChecked = this.checked;
                        const medItem = this.closest('.medication-item');
                        const medName = this.getAttribute('data-med');
                        
                        if (isChecked) {
                            medItem.classList.add('status-taken');
                            appData.medications[med.id] = true;
                            sendMedicationNotification(medName);
                        } else {
                            medItem.classList.remove('status-taken');
                            delete appData.medications[med.id];
                        }
                        
                        updateProgress();
                        saveToLocalStorage();
                    });
                }
            });
            
            // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©
            document.querySelectorAll('.send-group-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const timeSlot = this.getAttribute('data-time');
                    sendGroupNotification(timeSlot);
                });
            });
            
            // Ø²Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            document.getElementById('send-test-notification').addEventListener('click', function() {
                sendMedicationNotification('Ø¯ÙˆØ§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±');
            });
            
            // Ø²Ø± ØªØ¹Ù„ÙŠÙ… Ø§Ù„ÙƒÙ„ ÙƒÙ…Ø£Ø®ÙˆØ°
            document.getElementById('mark-all-taken').addEventListener('click', function() {
                medications.forEach(med => {
                    const checkbox = document.getElementById(med.id);
                    if (checkbox) {
                        checkbox.checked = true;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });
            });
            
            // Ø²Ø± Ø¨Ø¯Ø¡ ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯
            document.getElementById('reset-day').addEventListener('click', function() {
                if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¨Ø¯Ø¡ ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯ØŸ')) {
                    medications.forEach(med => {
                        const checkbox = document.getElementById(med.id);
                        if (checkbox) {
                            checkbox.checked = false;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    });
                    showNotification('ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯', 'ØªÙ… Ø¨Ø¯Ø¡ ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }
            });
            
            // Ù†Ø³Ø® Ø§Ù„Ù€ Token
            document.getElementById('copy-token-btn').addEventListener('click', function() {
                copyToClipboard(appData.fcmToken);
                showNotification('ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø² Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©', 'success');
            });
            
            // Ø­ÙØ¸ Ø±Ù…Ø² Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ©
            document.getElementById('save-caregiver-token').addEventListener('click', function() {
                const token = document.getElementById('caregiver-token-input').value.trim();
                if (token) {
                    appData.caregiverToken = token;
                    localStorage.setItem('caregiverToken', token);
                    showNotification('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'ØªÙ… Ø­ÙØ¸ Ø±Ù…Ø² Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ©', 'success');
                    console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø±Ù…Ø² Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ©:', token);
                } else {
                    showNotification('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù…Ø²', 'warning');
                }
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶
            document.getElementById('patient-name-input').addEventListener('change', function() {
                appData.patientName = this.value;
                document.getElementById('patient-name').textContent = this.value;
                saveToLocalStorage();
                savePatientData(appData.fcmToken);
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ù…Ø± Ø§Ù„Ù…Ø±ÙŠØ¶
            document.getElementById('patient-age-input').addEventListener('change', function() {
                appData.patientAge = parseInt(this.value) || 65;
                saveToLocalStorage();
                savePatientData(appData.fcmToken);
            });
        }
        
        // ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø©
        function displayFCMToken(token) {
            const shortToken = token.substring(0, 30) + '...';
            document.getElementById('fcm-token-display').textContent = token;
            document.getElementById('fcm-token-short').textContent = shortToken;
            document.getElementById('notification-status').textContent = 'Ù…ÙØ¹Ù„';
            document.getElementById('notification-status').style.color = '#2ecc71';
        }
        
        function updateFirebaseStatus(message, status) {
            const statusDot = document.getElementById('firebase-status-dot');
            const statusText = document.getElementById('firebase-status-text');
            
            statusText.textContent = message;
            
            if (status === 'connected') {
                statusDot.className = 'status-dot status-connected';
                statusText.style.color = '#2ecc71';
            } else if (status === 'connecting') {
                statusDot.className = 'status-dot';
                statusDot.style.background = '#ff9800';
                statusText.style.color = '#ff9800';
            } else {
                statusDot.className = 'status-dot';
                statusDot.style.background = '#f44336';
                statusText.style.color = '#f44336';
            }
        }
        
        function showNotification(title, message, type = 'info') {
            const notification = document.getElementById('floating-notification');
            notification.innerHTML = `<strong>${title}</strong><br>${message}`;
            notification.style.background = type === 'success' ? '#2ecc71' : 
                                           type === 'error' ? '#e74c3c' : 
                                           type === 'warning' ? '#f39c12' : '#3498db';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        function updateProgress() {
            const takenCount = Object.keys(appData.medications).length;
            const totalCount = medications.length;
            const percentage = (takenCount / totalCount) * 100;
            
            document.getElementById('taken-count').textContent = `${takenCount}/${totalCount}`;
            document.getElementById('progress-bar').style.width = `${percentage}%`;
        }
        
        function addToNotificationHistory(title, message) {
            const history = document.getElementById('notification-history');
            const time = new Date().toLocaleTimeString('ar-EG');
            const item = document.createElement('div');
            item.innerHTML = `<div style="padding: 8px; border-bottom: 1px solid #eee;">
                <div><strong>${title}</strong></div>
                <div style="font-size: 0.9rem; color: #666;">${message} - ${time}</div>
            </div>`;
            
            history.insertBefore(item, history.firstChild);
            
            if (history.children.length > 10) {
                history.removeChild(history.lastChild);
            }
        }
        
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ar-EG');
            document.getElementById('last-update-time').textContent = `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${timeString}`;
            
            setInterval(() => {
                const now = new Date();
                const timeString = now.toLocaleTimeString('ar-EG');
                document.getElementById('last-update-time').textContent = `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${timeString}`;
            }, 60000);
        }
        
        function saveToLocalStorage() {
            appData.lastUpdate = new Date().toISOString();
            localStorage.setItem('patientAppData', JSON.stringify(appData));
        }
        
        function loadSavedData() {
            const saved = localStorage.getItem('patientAppData');
            if (saved) {
                const parsed = JSON.parse(saved);
                Object.assign(appData, parsed);
                
                document.getElementById('patient-name-input').value = appData.patientName;
                document.getElementById('patient-name').textContent = appData.patientName;
                document.getElementById('patient-age-input').value = appData.patientAge;
                
                if (appData.caregiverToken) {
                    document.getElementById('caregiver-token-input').value = appData.caregiverToken;
                }
                
                medications.forEach(med => {
                    const checkbox = document.getElementById(med.id);
                    if (checkbox && appData.medications[med.id]) {
                        checkbox.checked = true;
                        checkbox.closest('.medication-item').classList.add('status-taken');
                    }
                });
            }
        }
        
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
        setInterval(() => {
            updateFirebaseStatus('Ù…ØªØµÙ„', 'connected');
        }, 30000);
    </script>
</body>
</html>